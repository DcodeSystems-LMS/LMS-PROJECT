var r=Object.defineProperty,e=(e,t,a)=>((e,t,a)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);import{supabase as t}from"./supabase-DCVaQTjR.js";import"./supabase-BMSNwJ-5.js";import"./vendor-D_DxLZN2.js";const a=new class{constructor(){e(this,"currentUser",null)}async signIn(r,e){var a,n,s,i,o;try{const{data:u,error:l}=await t.auth.signInWithPassword({email:r,password:e});if(l)throw new Error(l.message);if(!u.user)throw new Error("No user returned from authentication");u.user.email_confirmed_at||console.log("Email not verified but allowing sign in for development");const{data:c,error:d}=await t.from("profiles").select("*").eq("id",u.user.id).single();if(d||!c){console.log("Profile not found, creating new profile...");const e={id:u.user.id,email:u.user.email||r,name:(null==(a=u.user.user_metadata)?void 0:a.name)||"User",role:(null==(n=u.user.user_metadata)?void 0:n.role)||"student",avatar_url:(null==(s=u.user.user_metadata)?void 0:s.avatar_url)||null,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{data:l,error:c}=await t.from("profiles").insert(e).select().single();if(c){console.warn("Failed to create profile, using session data:",c);const e={id:u.user.id,email:u.user.email||r,name:(null==(i=u.user.user_metadata)?void 0:i.name)||"User",role:(null==(o=u.user.user_metadata)?void 0:o.role)||"student",created_at:u.user.created_at,updated_at:(new Date).toISOString()};return this.currentUser=e,e}const d={id:l.id,email:l.email,name:l.name,role:l.role,avatar:l.avatar_url,created_at:l.created_at,updated_at:l.updated_at};return this.currentUser=d,d}const m={id:c.id,email:c.email,name:c.name,role:c.role,avatar:c.avatar_url,created_at:c.created_at,updated_at:c.updated_at};return this.currentUser=m,m}catch(u){throw console.error("Sign in error:",u),new Error(u instanceof Error?u.message:"Sign in failed")}}async signUp(r,e,a,n="student"){try{const{data:s,error:i}=await t.auth.signUp({email:r,password:e,options:{data:{name:a,role:n}}});if(i)throw new Error(i.message);if(!s.user)throw new Error("No user returned from registration");if(!s.user.email_confirmed_at){console.log("Email verification required but skipping for development");const e={id:s.user.id,email:s.user.email||r,name:a,role:n,created_at:s.user.created_at,updated_at:(new Date).toISOString()};return this.currentUser=e,{user:e,needsVerification:!1}}const o={id:s.user.id,email:s.user.email||r,name:a,role:n,created_at:s.user.created_at,updated_at:(new Date).toISOString()};return this.currentUser=o,{user:o,needsVerification:!1}}catch(s){throw console.error("Sign up error:",s),new Error(s instanceof Error?s.message:"Sign up failed")}}async signOut(){try{const{error:r}=await t.auth.signOut();if(r)throw new Error(r.message);this.currentUser=null}catch(r){throw console.error("Sign out error:",r),new Error(r instanceof Error?r.message:"Sign out failed")}}async getCurrentUser(){var r,e,a,n,s;try{const{data:{session:i},error:o}=await t.auth.getSession();if(o)return console.error("Get session error:",o),null;if(!(null==i?void 0:i.user))return this.currentUser=null,null;const{data:u,error:l}=await t.from("profiles").select("*").eq("id",i.user.id).single();if(l||!u){console.log("Profile not found, creating new profile...");const o={id:i.user.id,email:i.user.email||"",name:(null==(r=i.user.user_metadata)?void 0:r.name)||"User",role:(null==(e=i.user.user_metadata)?void 0:e.role)||"student",avatar_url:(null==(a=i.user.user_metadata)?void 0:a.avatar_url)||null,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{data:u,error:l}=await t.from("profiles").insert(o).select().single();if(l){console.warn("Failed to create profile, using session data:",l);const r={id:i.user.id,email:i.user.email||"",name:(null==(n=i.user.user_metadata)?void 0:n.name)||"User",role:(null==(s=i.user.user_metadata)?void 0:s.role)||"student",created_at:i.user.created_at,updated_at:(new Date).toISOString()};return this.currentUser=r,r}const c={id:u.id,email:u.email,name:u.name,role:u.role,avatar:u.avatar_url,created_at:u.created_at,updated_at:u.updated_at};return this.currentUser=c,c}const c={id:u.id,email:u.email,name:u.name,role:u.role,avatar:u.avatar_url,created_at:u.created_at,updated_at:u.updated_at};return this.currentUser=c,c}catch(i){return console.error("Get current user error:",i),this.currentUser=null,null}}getCurrentUserSync(){return this.currentUser}async isAuthenticated(){return null!==await this.getCurrentUser()}async resetPassword(r){try{const{error:e}=await t.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/auth/reset-password`});if(e)throw new Error(e.message)}catch(e){throw console.error("Reset password error:",e),new Error(e instanceof Error?e.message:"Reset password failed")}}async initialize(){try{await this.getCurrentUser(),t.auth.onAuthStateChange(async(r,e)=>{"SIGNED_IN"===r&&(null==e?void 0:e.user)?await this.getCurrentUser():"SIGNED_OUT"===r&&(this.currentUser=null)})}catch(r){console.error("Auth initialization error:",r)}}async resendVerificationEmail(r){try{const{error:e}=await t.auth.resend({type:"signup",email:r});if(e)throw new Error(e.message)}catch(e){throw console.error("Resend verification error:",e),new Error(e instanceof Error?e.message:"Failed to resend verification email")}}async updateProfile(r){try{if(!this.currentUser)throw new Error("No authenticated user");const{data:e,error:a}=await t.from("profiles").update({name:r.name,avatar_url:r.avatar,updated_at:(new Date).toISOString()}).eq("id",this.currentUser.id).select().single();if(a)throw new Error(a.message);const n={...this.currentUser,name:e.name,avatar:e.avatar_url,updated_at:e.updated_at};return this.currentUser=n,n}catch(e){throw console.error("Update profile error:",e),new Error(e instanceof Error?e.message:"Update profile failed")}}};const n=new class{constructor(){e(this,"currentUser",null)}async signIn(r,e){try{const t=await a.signIn(r,e);return this.currentUser=t,t}catch(t){throw console.error("Sign in error:",t),new Error(t instanceof Error?t.message:"Sign in failed")}}async signUp(r,e,t,n="student"){try{const s=await a.signUp(r,e,t,n);return s.user&&(this.currentUser=s.user),s}catch(s){throw console.error("Sign up error:",s),new Error(s instanceof Error?s.message:"Sign up failed")}}async signOut(){await a.signOut(),this.currentUser=null}async getCurrentUser(){try{const r=await a.getCurrentUser();return this.currentUser=r,r}catch(r){return console.error("Get current user error:",r),this.currentUser=null,null}}getCurrentUserSync(){return a.getCurrentUserSync()}async isAuthenticated(){return null!==await this.getCurrentUser()}async resetPassword(r){try{await a.resetPassword(r)}catch(e){throw console.error("Reset password error:",e),new Error(e instanceof Error?e.message:"Reset password failed")}}async initialize(){await a.initialize(),this.currentUser=await a.getCurrentUser()}async resendVerificationEmail(r){try{await a.resendVerificationEmail(r)}catch(e){throw console.error("Resend verification error:",e),new Error(e instanceof Error?e.message:"Failed to resend verification email")}}async updateProfile(r){try{const e=await a.updateProfile(r);return this.currentUser=e,e}catch(e){throw console.error("Update profile error:",e),new Error(e instanceof Error?e.message:"Update profile failed")}}};export{n as authService};
