import{s as e}from"./index-BaWXG3YY.js";class s{static async testConnection(){try{const{data:s,error:t}=await e.from("profiles").select("count").limit(1);return t?(console.error("Supabase connection test failed:",t),!1):(console.log("Supabase connection test successful"),!0)}catch(s){return console.error("Supabase connection test error:",s),!1}}static async getProfiles(s){let t=e.from("profiles").select("*");s&&(t=t.eq("role",s));const{data:r,error:o}=await t;if(o)throw o;return r||[]}static async getProfile(s){try{const{data:t,error:r}=await e.from("profiles").select("*").eq("id",s).single();return r?(console.warn("Error fetching profile:",r),null):t}catch(t){return console.warn("Profiles table may not exist or have permission issues:",t),null}}static async updateProfile(s,t){const{data:r,error:o}=await e.from("profiles").update(t).eq("id",s).select();return{data:r,error:o}}static async deleteProfile(s){try{const{error:t}=await e.from("profiles").delete().eq("id",s);return t?(console.warn("Error deleting profile:",t),{error:t}):(console.log("Profile deleted successfully"),{error:null})}catch(t){return console.warn("Profiles table may not exist or have permission issues:",t),{error:t}}}static async createProfile(s){try{const{data:t,error:r}=await e.from("profiles").insert(s).select().single();return r?(console.warn("Error creating profile:",r),{data:null,error:r}):(console.log("Profile created successfully"),{data:t,error:null})}catch(t){return console.warn("Profiles table may not exist or have permission issues:",t),{data:null,error:t}}}static async getCourses(){const{data:s,error:t}=await e.from("courses").select("\n        *,\n        instructor:profiles!instructor_id(*)\n      ");if(t)throw t;return s||[]}static async getCourse(s){const{data:t,error:r}=await e.from("courses").select("\n        *,\n        instructor:profiles!instructor_id(*)\n      ").eq("id",s).single();if(r)throw r;return t}static async createCourse(s){const{data:t,error:r}=await e.from("courses").insert(s).select().single();if(r)throw r;return t}static async updateCourse(s,t){const{error:r}=await e.from("courses").update(t).eq("id",s);if(r)throw r}static async deleteCourse(s){const{error:t}=await e.from("courses").delete().eq("id",s);if(t)throw t}static async getEnrollments(s){try{let t=e.from("enrollments").select("\n        *,\n        course:courses(*),\n        student:profiles!student_id(*)\n      ");s&&(t=t.eq("student_id",s),t=t.in("status",["enrolled","active","completed"]));const{data:r,error:o}=await t;return o?(console.warn("Error fetching enrollments:",o),[]):r||[]}catch(t){return console.warn("Enrollments table may not exist or have permission issues:",t),[]}}static async enrollInCourse(s,t){const{error:r}=await e.from("enrollments").insert({student_id:s,course_id:t,progress:0,status:"enrolled"});if(r)throw r}static async updateEnrollmentProgress(s,t){const{error:r}=await e.from("enrollments").update({progress:t}).eq("id",s);if(r)throw r}static async isStudentEnrolled(s,t){try{const{data:r,error:o}=await e.from("enrollments").select("id").eq("student_id",s).eq("course_id",t).in("status",["enrolled","active","completed"]).single();return o&&"PGRST116"!==o.code?(console.warn("Error checking enrollment:",o),!1):!!r}catch(r){return console.warn("Error checking enrollment:",r),!1}}static async updateEnrollmentStatus(s,t){const{error:r}=await e.from("enrollments").update({status:t}).eq("id",s);if(r)throw r}static async getAssessments(s){console.log("üîç DataService.getAssessments called with courseId:",s),console.log("üîç Supabase URL:","https://gtzbjzsjeftkgwvvgefp.supabase.co"),console.log("üîç Supabase Key exists:",!0);let t=e.from("assessments").select("\n      *,\n      course:courses(*),\n      instructor:profiles!instructor_id(*)\n    ");s&&(t=t.eq("course_id",s));const{data:r,error:o}=await t;if(o)throw console.error("‚ùå Error fetching assessments:",o),console.error("‚ùå Error details:",{message:o.message,details:o.details,hint:o.hint,code:o.code}),o;return console.log("‚úÖ Assessments fetched successfully:",r),console.log("‚úÖ Assessments count:",(null==r?void 0:r.length)||0),r||[]}static async getAssessment(s){const{data:t,error:r}=await e.from("assessments").select("\n        *,\n        course:courses(*),\n        instructor:profiles!instructor_id(*)\n      ").eq("id",s).single();if(r)throw r;return t}static async getAssessmentWithQuestionCount(s){try{const{data:t,error:r}=await e.from("assessments").select("\n          *,\n          course:courses(*),\n          instructor:profiles!instructor_id(*)\n        ").eq("id",s).single();if(r)return console.error("Error fetching assessment:",r),{assessment:null,questionCount:0};const{data:o,error:n}=await e.from("questions").select("id").eq("assessment_id",s);return n?(console.warn("Error fetching question count:",n),{assessment:t,questionCount:0}):{assessment:t,questionCount:o?o.length:0}}catch(t){return console.error("Error in getAssessmentWithQuestionCount:",t),{assessment:null,questionCount:0}}}static async getStudentAssessments(s){console.log("üîç DataService.getStudentAssessments called for student:",s);try{let{data:t,error:r}=await e.from("student_assessments").select("\n          *,\n          assessment:assessments(\n            *,\n            course:courses(*),\n            instructor:profiles!instructor_id(*)\n          )\n        ").eq("student_id",s).in("assessment.status",["active","published","draft"]).order("assigned_at",{ascending:!1});if(r&&r.message.includes("status")){console.log("‚ö†Ô∏è Status column not found in student_assessments, trying without status filter");const{data:o,error:n}=await e.from("student_assessments").select("\n            *,\n            assessment:assessments(\n              *,\n              course:courses(*),\n              instructor:profiles!instructor_id(*)\n            )\n          ").eq("student_id",s).order("assigned_at",{ascending:!1});t=o,r=n}if(r&&console.warn("‚ö†Ô∏è student_assessments table not found, falling back to enrollment-based method"),!t||0===t.length){console.log("‚ö†Ô∏è No assessments assigned to this student, falling back to enrollment-based method"),console.log("üîç Fetching enrollments for student:",s);const{data:t,error:r}=await e.from("enrollments").select("course_id, status").eq("student_id",s).in("status",["enrolled","active","completed"]);if(r)return console.error("‚ùå Error fetching student enrollments:",r),[];if(console.log("üìä Enrollments found:",(null==t?void 0:t.length)||0),console.log("üìä Enrollment details:",t),!t||0===t.length)return console.log("‚ö†Ô∏è Student not enrolled in any courses or no active enrollments"),[];const o=t.map(e=>e.course_id);console.log("üìö Student enrolled in courses:",o);let{data:n,error:a}=await e.from("assessments").select("\n            *,\n            course:courses(*),\n            instructor:profiles!instructor_id(*)\n          ").in("course_id",o).in("status",["active","published","draft"]).order("created_at",{ascending:!1});if(a&&a.message.includes("status")){console.log("‚ö†Ô∏è Status column not found, fetching all assessments for enrolled courses");const{data:s,error:t}=await e.from("assessments").select("\n              *,\n              course:courses(*),\n              instructor:profiles!instructor_id(*)\n            ").in("course_id",o).order("created_at",{ascending:!1});n=s,a=t}return a?(console.error("‚ùå Error fetching student assessments:",a),[]):(console.log("‚úÖ Student assessments fetched successfully (fallback method):",(null==n?void 0:n.length)||0),console.log("üìä Raw assessment data:",n),console.log("üìä Assessment details:",null==n?void 0:n.map(e=>{var s;return{id:e.id,title:e.title,course_id:e.course_id,status:e.status,course_title:null==(s=e.course)?void 0:s.title}})),n||[])}const o=t.map(e=>e.assessment).filter(e=>null!==e);return console.log("‚úÖ Student assessments fetched successfully (new method):",o.length),console.log("üìö Student assessment details:",o.map(e=>{var s;return{id:e.id,title:e.title,course:null==(s=e.course)?void 0:s.title,status:e.status}})),o}catch(t){return console.error("‚ùå Error in getStudentAssessments:",t),[]}}static async getAssessmentQuestions(s){try{console.log("üîç Fetching questions for assessment:",s);const{data:r,error:o}=await e.from("questions").select("*").eq("assessment_id",s).order("order_index");if(o)console.warn("‚ö†Ô∏è questions table not found, falling back to JSON storage method:",o);else{if(r&&0!==r.length)return console.log("‚úÖ Questions fetched from questions table:",r.length),r;console.warn("‚ö†Ô∏è No questions found in questions table, falling back to JSON storage method")}const{data:n,error:a}=await e.from("assessments").select("questions").eq("id",s).single();if(a)return console.error("‚ùå Error fetching assessment:",a),[];if((null==n?void 0:n.questions)&&Array.isArray(n.questions))return console.log("‚úÖ Found questions in assessment data:",n.questions.length),n.questions;if((null==n?void 0:n.questions)&&"string"==typeof n.questions)try{const e=JSON.parse(n.questions);return console.log("‚úÖ Parsed questions from JSON:",e.length),e}catch(t){return console.error("‚ùå Error parsing questions JSON:",t),[]}return console.warn("‚ö†Ô∏è No questions found in assessment data"),[]}catch(r){return console.error("‚ùå Error fetching questions:",r),[]}}static async createQuestion(s){try{console.log("üîç Creating question:",s);const t={...s,options:s.options?JSON.stringify(s.options):null,correct_answers:s.correct_answers?JSON.stringify(s.correct_answers):null,test_cases:s.test_cases?JSON.stringify(s.test_cases):null,blank_positions:s.blank_positions?JSON.stringify(s.blank_positions):null,media_files:s.media_files?JSON.stringify(s.media_files):null,tags:s.tags||[],points:s.points||1,order_index:s.order_index||1};console.log("üîç Processed question data:",t);const{data:r,error:o}=await e.from("questions").insert(t).select().single();return o?(console.error("‚ùå Error creating question:",o),{data:null,error:o}):(console.log("‚úÖ Question created successfully:",r),{data:r,error:null})}catch(t){return console.error("‚ùå Error in createQuestion:",t),{data:null,error:t}}}static async updateQuestion(s,t){try{console.log("üîç Updating question:",s,t);const{data:r,error:o}=await e.from("questions").update(t).eq("id",s).select().single();return o?(console.error("‚ùå Error updating question:",o),{data:null,error:o}):(console.log("‚úÖ Question updated successfully:",r),{data:r,error:null})}catch(r){return console.error("‚ùå Error in updateQuestion:",r),{data:null,error:r}}}static async deleteQuestion(s){try{console.log("üîç Deleting question:",s);const{error:t}=await e.from("questions").delete().eq("id",s);return t?(console.error("‚ùå Error deleting question:",t),{error:t}):(console.log("‚úÖ Question deleted successfully"),{error:null})}catch(t){return console.error("‚ùå Error in deleteQuestion:",t),{error:t}}}static async getAssessmentAttempts(s,t){try{console.log("üîç Fetching assessment attempts for student:",s,"assessment:",t);const{data:r,error:o}=await e.from("assessment_attempts").select("*").eq("student_id",s).eq("assessment_id",t).order("started_at",{ascending:!1});return o?(console.warn("‚ö†Ô∏è Error fetching assessment attempts:",o),[]):(console.log("‚úÖ Assessment attempts fetched:",(null==r?void 0:r.length)||0),r||[])}catch(r){return console.error("‚ùå Error in getAssessmentAttempts:",r),[]}}static async getAssessmentDetails(s,t){var r;try{console.log("üîç Fetching assessment details for:",s);const{data:o,error:n}=await e.from("assessments").select("\n          *,\n          course:courses(*),\n          instructor:profiles!instructor_id(*)\n        ").eq("id",s).single();if(n)return console.error("‚ùå Error fetching assessment:",n),null;const{data:a,error:i}=await e.from("questions").select("id").eq("assessment_id",s),l=(null==a?void 0:a.length)||0;let c=[],u=3;t&&(c=await this.getAssessmentAttempts(t,s),u=o.max_attempts||3);const d=o.tags||(null==(r=o.course)?void 0:r.tags)||["General Topics"];let m="Good work!";c.length>0&&c[0].feedback?m=c[0].feedback:o.instructor_feedback&&(m=o.instructor_feedback);const f={...o,questionCount:l,attempts:c.length,maxAttempts:u,topics:Array.isArray(d)?d:[d],feedback:m,duration:o.time_limit_minutes?`${o.time_limit_minutes} mins`:"30 mins",difficulty:o.difficulty_level||"Easy",type:o.type||"Quiz"};return console.log("‚úÖ Assessment details fetched:",f),f}catch(o){return console.error("‚ùå Error in getAssessmentDetails:",o),null}}static async getAssessmentResults(s){try{console.log("üîç Fetching assessment results for mentor:",s);const{data:t,error:r}=await e.from("assessment_results").select("\n          *,\n          profiles!assessment_results_student_id_fkey(id, name, email)\n        ").eq("assessment_id",s).order("completed_at",{ascending:!1});if(r){console.warn("assessment_results table not found, trying assessment_attempts:",r.message);const{data:t,error:o}=await e.from("assessment_attempts").select("\n            *,\n            profiles!assessment_attempts_student_id_fkey(id, name, email)\n          ").eq("assessment_id",s).eq("status","completed").order("completed_at",{ascending:!1});return o?(console.error("‚ùå Error fetching assessment attempts:",o),{data:[],error:o}):(console.log("‚úÖ Assessment attempts fetched:",t),{data:t||[],error:null})}return console.log("‚úÖ Assessment results fetched:",t),{data:t||[],error:null}}catch(t){return console.error("‚ùå Error in getAssessmentResults:",t),{data:[],error:t}}}static async saveAssessmentResult(s){try{console.log("üíæ Saving assessment result:",s);const{data:t,error:r}=await e.rpc("save_assessment_result",{p_student_id:s.student_id,p_assessment_id:s.assessment_id,p_attempt_id:s.attempt_id||null,p_score:s.score,p_total_points:s.total_points||0,p_answers:s.answers,p_feedback:s.feedback||null});if(r){console.error("‚ùå RPC function failed:",r);const{data:t,error:o}=await e.from("assessment_results").insert({student_id:s.student_id,assessment_id:s.assessment_id,attempt_id:s.attempt_id,score:s.score,total_points:s.total_points||0,answers:s.answers,feedback:s.feedback}).select().single();return o?(console.error("‚ùå Direct insert also failed:",o),console.log("‚ö†Ô∏è Assessment result could not be saved to database, but score was calculated"),{data:null,error:o}):(console.log("‚úÖ Assessment result saved via direct insert:",t),{data:t,error:null})}return console.log("‚úÖ Assessment result saved via RPC:",t),{data:t,error:null}}catch(t){return console.error("‚ùå Error in saveAssessmentResult:",t),{data:null,error:t}}}static async createAssessment(s){console.log("DataService.createAssessment called with:",s);const{data:t,error:r}=await e.from("assessments").insert(s).select().single();if(r)throw console.error("Supabase error in createAssessment:",r),r;return console.log("Assessment created successfully:",t),t}static async createAssessmentWithQuestions(s,t){console.log("üîç DataService.createAssessmentWithQuestions called"),console.log("üìù Assessment data:",s),console.log("‚ùì Questions data:",t);try{const{data:r,error:o}=await e.from("assessments").insert(s).select().single();if(o)throw console.error("‚ùå Error creating assessment:",o),o;if(console.log("‚úÖ Assessment created:",r.id),t&&t.length>0){const s=t.map((e,s)=>({assessment_id:r.id,question_text:e.question_text,question_type:e.type||"multiple-choice",options:e.options?JSON.stringify(e.options):null,correct_answer:e.correct_answer,explanation:e.explanation,points:e.points||1,order_index:e.order_index||s+1})),{data:o,error:n}=await e.from("questions").insert(s).select("*");n?console.error("‚ùå Error creating questions:",n):console.log("‚úÖ Questions created:",(null==o?void 0:o.length)||0)}const{data:n,error:a}=await e.from("enrollments").select("student_id").eq("course_id",s.course_id);if(!a&&n&&n.length>0){const t=n.map(e=>({student_id:e.student_id,assessment_id:r.id,assigned_by:s.instructor_id})),{error:o}=await e.from("student_assessments").insert(t);o?console.warn("‚ö†Ô∏è Error creating student assignments:",o):console.log("‚úÖ Student assignments created:",t.length)}return{assessment:r,questions:t||[]}}catch(r){throw console.error("‚ùå Error in createAssessmentWithQuestions:",r),r}}static async updateAssessment(s,t){console.log("üîß DataService.updateAssessment called with ID:",s),console.log("üîß Updates:",t),console.log("üîß Supabase URL:","https://gtzbjzsjeftkgwvvgefp.supabase.co"),console.log("üîß Supabase Key exists:",!0);const{data:{user:r},error:o}=await e.auth.getUser();if(console.log("üîß Current user:",null==r?void 0:r.id),console.log("üîß User error:",o),r){const{data:s,error:t}=await e.from("profiles").select("role").eq("id",r.id).single();console.log("üîß User profile:",s),console.log("üîß Profile error:",t)}console.log("üîß About to execute update query...");const{error:n}=await e.from("assessments").update(t).eq("id",s);if(console.log("üîß Update query executed, checking for errors..."),n)throw console.error("‚ùå Error updating assessment:",n),console.error("‚ùå Error details:",{message:n.message,details:n.details,hint:n.hint,code:n.code}),n;console.log("‚úÖ Assessment updated successfully"),console.log("üîç Verifying update by checking if assessment was updated...");const{data:a,error:i}=await e.from("assessments").select("id, title, type, status").eq("id",s).single();i?console.error("‚ùå Verification failed:",i):console.log("‚úÖ Verification successful - assessment updated:",a)}static async duplicateAssessment(e){console.log("üìã DataService.duplicateAssessment called with ID:",e);const t=await s.getAssessment(e);if(!t)throw new Error("Assessment not found");const r={title:`${t.title} (Copy)`,description:t.description,course_id:t.course_id,instructor_id:t.instructor_id,type:t.type,difficulty:t.difficulty,time_limit_minutes:t.time_limit_minutes,passing_score:t.passing_score,questions:t.questions,status:"draft"},o=await s.createAssessment(r);return console.log("‚úÖ Assessment duplicated successfully:",o),o}static async deleteAssessment(s){console.log("üóëÔ∏è DataService.deleteAssessment called with ID:",s),console.log("üóëÔ∏è Supabase URL:","https://gtzbjzsjeftkgwvvgefp.supabase.co"),console.log("üóëÔ∏è Supabase Key exists:",!0);const{data:{user:t},error:r}=await e.auth.getUser();if(console.log("üóëÔ∏è Current user:",null==t?void 0:t.id),console.log("üóëÔ∏è User error:",r),t){const{data:s,error:r}=await e.from("profiles").select("role").eq("id",t.id).single();console.log("üóëÔ∏è User profile:",s),console.log("üóëÔ∏è Profile error:",r)}console.log("üóëÔ∏è About to execute delete query...");const{error:o}=await e.from("assessments").delete().eq("id",s);if(console.log("üóëÔ∏è Delete query executed, checking for errors..."),o)throw console.error("‚ùå Error deleting assessment:",o),console.error("‚ùå Error details:",{message:o.message,details:o.details,hint:o.hint,code:o.code}),o;console.log("‚úÖ Assessment deleted successfully from database"),console.log("üîç Verifying deletion by checking if assessment still exists...");const{data:n,error:a}=await e.from("assessments").select("id").eq("id",s).single();a&&"PGRST116"===a.code?console.log("‚úÖ Verification successful - assessment no longer exists"):n?console.error("‚ùå Verification failed - assessment still exists:",n):console.log("üîç Verification result:",a)}static async getAssessmentResults(s,t){let r=e.from("assessment_results").select("\n      *,\n      student:profiles!student_id(*),\n      assessment:assessments(*)\n    ");s&&(r=r.eq("student_id",s)),t&&(r=r.eq("assessment_id",t));const{data:o,error:n}=await r;if(n)throw n;return o||[]}static async submitAssessmentResult(s){const{error:t}=await e.from("assessment_results").insert(s);if(t)throw t}static async getSessions(s,t){try{let r=e.from("sessions").select("\n        *,\n        mentor:profiles!mentor_id(*),\n        student:profiles!student_id(*)\n      ");s&&"mentor"===t?r=r.eq("mentor_id",s):s&&"student"===t&&(r=r.eq("student_id",s));const{data:o,error:n}=await r;return n?(console.warn("Error fetching sessions:",n),[]):o||[]}catch(r){return console.warn("Sessions table may not exist or have permission issues:",r),[]}}static async createSession(s){const{data:t,error:r}=await e.from("sessions").insert(s).select().single();if(r)throw r;return t}static async updateSession(s,t){const{error:r}=await e.from("sessions").update(t).eq("id",s);if(r)throw r}static async getDiscussions(s){let t=e.from("discussions").select("\n      *,\n      author:profiles!author_id(*),\n      course:courses(*)\n    ");s&&(t=t.eq("course_id",s));const{data:r,error:o}=await t;if(o)throw o;return r||[]}static async createDiscussion(s){const{data:t,error:r}=await e.from("discussions").insert(s).select().single();if(r)throw r;return t}static async getNotifications(s){const{data:t,error:r}=await e.from("notifications").select("*").eq("user_id",s).order("created_at",{ascending:!1});if(r)throw r;return t||[]}static async createNotification(s){const{error:t}=await e.from("notifications").insert(s);if(t)throw t}static async markNotificationAsRead(s){const{error:t}=await e.from("notifications").update({read:!0}).eq("id",s);if(t)throw t}static async getAnalytics(){const[s,t,r,o]=await Promise.all([e.from("profiles").select("role"),e.from("courses").select("*"),e.from("enrollments").select("*"),e.from("sessions").select("*")]),n=s.data||[],a=t.data||[],i=r.data||[],l=o.data||[];return{totalUsers:n.length,activeUsers:n.filter(e=>"student"===e.role).length,totalCourses:a.length,totalEnrollments:i.length,totalSessions:l.length,completedSessions:l.filter(e=>"completed"===e.status).length}}static async searchContent(s){const[t,r,o]=await Promise.all([e.from("courses").select("*").ilike("title",`%${s}%`),e.from("profiles").select("*").ilike("name",`%${s}%`),e.from("discussions").select("*").ilike("title",`%${s}%`)]),n=[];return t.data&&n.push(...t.data.map(e=>({id:e.id,title:e.title,type:"course",description:e.description,url:`/courses/${e.id}`,metadata:{instructor:e.instructor_id}}))),r.data&&n.push(...r.data.map(e=>({id:e.id,title:e.name,type:"mentor",description:`${e.role} with experience`,url:`/mentors/${e.id}`}))),o.data&&n.push(...o.data.map(e=>({id:e.id,title:e.title,type:"discussion",description:e.content.substring(0,100)+"...",url:`/discussions/${e.id}`}))),n}static async getCourseMaterials(s){try{console.log("üîç Fetching course materials for course:",s);const{data:t,error:r}=await e.from("course_materials").select("\n          *,\n          course:courses(*),\n          uploadedBy:profiles(*)\n        ").eq("course_id",s).eq("is_public",!0).order("created_at",{ascending:!1});if(r){if(console.error("‚ùå Error fetching course materials:",r),console.error("‚ùå Error details:",{message:r.message,code:r.code,details:r.details,hint:r.hint}),"PGRST116"===r.code||r.message.includes("relation")||r.message.includes("permission"))return console.warn("‚ö†Ô∏è Course materials table may not exist or have permission issues"),[];if(r.message.includes("policy")||r.message.includes("RLS")){console.warn("‚ö†Ô∏è RLS policy blocking access, trying alternative approach...");const{data:t,error:r}=await e.from("course_materials").select("*").eq("course_id",s).eq("is_public",!0).order("created_at",{ascending:!1});return r?(console.error("‚ùå Alternative query also failed:",r),[]):(console.log("‚úÖ Course materials fetched with alternative query:",(null==t?void 0:t.length)||0,"materials"),t||[])}throw r}return console.log("‚úÖ Course materials fetched successfully:",(null==t?void 0:t.length)||0,"materials"),t||[]}catch(t){return console.error("‚ùå Error fetching course materials:",t),[]}}static async getMaterialsForStudent(e,s){try{console.log("üîç Checking enrollment for student:",s,"course:",e);return await this.isStudentEnrolled(s,e)?(console.log("üìö Loading course materials for course:",e),await this.getCourseMaterials(e)):(console.warn("Student not enrolled in course"),[])}catch(t){return console.error("‚ùå Error fetching materials for student:",t),console.error("‚ùå Error details:",{message:t.message,code:t.code,details:t.details,hint:t.hint}),[]}}static async uploadCourseMaterial(s,t,r){var o;try{const{data:{user:n}}=await e.auth.getUser();if(!n)return{data:null,error:{message:"User not authenticated"}};const a=(null==(o=t.name.split(".").pop())?void 0:o.toLowerCase())||"",i=`course-materials/${s}/${`${Date.now()}-${t.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`}`,{data:l,error:c}=await e.storage.from("course-materials").upload(i,t,{cacheControl:"3600",upsert:!1});if(c)return console.error("File upload error:",c),{data:null,error:c};const{data:u,error:d}=await e.from("course_materials").insert({course_id:s,lesson_id:r.lessonId?parseInt(r.lessonId.toString()):null,title:r.title,description:r.description,file_name:t.name,file_path:i,file_size:t.size,file_type:t.type,file_extension:a,category:r.category||"general",is_public:!0,uploaded_by:n.id}).select("\n          *,\n          course:courses(*),\n          uploadedBy:profiles(*)\n        ").single();return d?(await e.storage.from("course-materials").remove([i]),{data:null,error:d}):{data:u,error:null}}catch(n){return console.error("Error uploading course material:",n),{data:null,error:n}}}static async deleteCourseMaterial(s){try{const{data:t,error:r}=await e.from("course_materials").select("file_path").eq("id",s).single();if(r)return{error:r};const{error:o}=await e.from("course_materials").delete().eq("id",s);return o?{error:o}:((null==t?void 0:t.file_path)&&await e.storage.from("course-materials").remove([t.file_path]),{error:null})}catch(t){return console.error("Error deleting course material:",t),{error:t}}}static async getMaterialDownloadUrl(s){try{const{data:r,error:o}=await e.from("course_materials").select("file_path, file_name, title").eq("id",s).single();if(o||!r)return console.error("‚ùå Material not found:",{materialId:s,error:o}),{url:null,error:o||new Error("Material not found")};if(!r.file_path)return console.error("‚ùå Material has no file path:",r),{url:null,error:new Error("Material file path is missing")};console.log("üîç Attempting to create signed URL for:",{materialId:s,filePath:r.file_path,fileName:r.file_name,title:r.title});const{data:n,error:a}=await e.storage.from("course-materials").createSignedUrl(r.file_path,3600);if(a)return console.error("‚ùå Failed to create signed URL:",{filePath:r.file_path,error:a}),{url:null,error:a};console.log("‚úÖ Signed URL created successfully for:",r.file_name);try{await e.rpc("increment_material_download_count",{material_id:s})}catch(t){console.warn("‚ö†Ô∏è Failed to increment download count:",t)}return{url:n.signedUrl,error:null}}catch(r){return console.error("‚ùå Error getting material download URL:",r),{url:null,error:r}}}static async updateCourseMaterial(s,t){try{const{data:r,error:o}=await e.from("course_materials").update(t).eq("id",s).select("\n          *,\n          course:courses(*),\n          uploadedBy:profiles(*)\n        ").single();return{data:r,error:o}}catch(r){return console.error("Error updating course material:",r),{data:null,error:r}}}}export{s as D};
