import{supabase as e}from"./supabase-DCVaQTjR.js";class s{static async testConnection(){try{const{data:s,error:r}=await e.from("profiles").select("count").limit(1);return r?(console.error("Supabase connection test failed:",r),!1):(console.log("Supabase connection test successful"),!0)}catch(s){return console.error("Supabase connection test error:",s),!1}}static async getProfiles(s){let r=e.from("profiles").select("*");s&&(r=r.eq("role",s));const{data:t,error:o}=await r;if(o)throw o;return t||[]}static async getProfile(s){try{const{data:r,error:t}=await e.from("profiles").select("*").eq("id",s).single();return t?(console.warn("Error fetching profile:",t),null):r}catch(r){return console.warn("Profiles table may not exist or have permission issues:",r),null}}static async updateProfile(s,r){const{data:t,error:o}=await e.from("profiles").update(r).eq("id",s).select();return{data:t,error:o}}static async deleteProfile(s){try{const{error:r}=await e.from("profiles").delete().eq("id",s);return r?(console.warn("Error deleting profile:",r),{error:r}):(console.log("Profile deleted successfully"),{error:null})}catch(r){return console.warn("Profiles table may not exist or have permission issues:",r),{error:r}}}static async createProfile(s){try{const{data:r,error:t}=await e.from("profiles").insert(s).select().single();return t?(console.warn("Error creating profile:",t),{data:null,error:t}):(console.log("Profile created successfully"),{data:r,error:null})}catch(r){return console.warn("Profiles table may not exist or have permission issues:",r),{data:null,error:r}}}static async getCourses(){const{data:s,error:r}=await e.from("courses").select("\n        *,\n        instructor:profiles!instructor_id(*)\n      ");if(r)throw r;return s||[]}static async getCourse(s){const{data:r,error:t}=await e.from("courses").select("\n        *,\n        instructor:profiles!instructor_id(*)\n      ").eq("id",s).single();if(t)throw t;return r}static async createCourse(s){const{data:r,error:t}=await e.from("courses").insert(s).select().single();if(t)throw t;return r}static async updateCourse(s,r){const{error:t}=await e.from("courses").update(r).eq("id",s);if(t)throw t}static async deleteCourse(s){const{error:r}=await e.from("courses").delete().eq("id",s);if(r)throw r}static async getEnrollments(s){try{let r=e.from("enrollments").select("\n        *,\n        course:courses(*),\n        student:profiles!student_id(*)\n      ");s&&(r=r.eq("student_id",s));const{data:t,error:o}=await r;return o?(console.warn("Error fetching enrollments:",o),[]):t||[]}catch(r){return console.warn("Enrollments table may not exist or have permission issues:",r),[]}}static async enrollInCourse(s,r){const{error:t}=await e.from("enrollments").insert({student_id:s,course_id:r,progress:0});if(t)throw t}static async updateEnrollmentProgress(s,r){const{error:t}=await e.from("enrollments").update({progress:r}).eq("id",s);if(t)throw t}static async getAssessments(s){console.log("üîç DataService.getAssessments called with courseId:",s),console.log("üîç Supabase URL:","https://gtzbjzsjeftkgwvvgefp.supabase.co"),console.log("üîç Supabase Key exists:",!0);let r=e.from("assessments").select("\n      *,\n      course:courses(*),\n      instructor:profiles!instructor_id(*)\n    ");s&&(r=r.eq("course_id",s));const{data:t,error:o}=await r;if(o)throw console.error("‚ùå Error fetching assessments:",o),console.error("‚ùå Error details:",{message:o.message,details:o.details,hint:o.hint,code:o.code}),o;return console.log("‚úÖ Assessments fetched successfully:",t),console.log("‚úÖ Assessments count:",(null==t?void 0:t.length)||0),t||[]}static async getAssessment(s){const{data:r,error:t}=await e.from("assessments").select("\n        *,\n        course:courses(*),\n        instructor:profiles!instructor_id(*)\n      ").eq("id",s).single();if(t)throw t;return r}static async createAssessment(s){console.log("DataService.createAssessment called with:",s);const{data:r,error:t}=await e.from("assessments").insert(s).select().single();if(t)throw console.error("Supabase error in createAssessment:",t),t;return console.log("Assessment created successfully:",r),r}static async updateAssessment(s,r){console.log("üîß DataService.updateAssessment called with ID:",s),console.log("üîß Updates:",r),console.log("üîß Supabase URL:","https://gtzbjzsjeftkgwvvgefp.supabase.co"),console.log("üîß Supabase Key exists:",!0);const{data:{user:t},error:o}=await e.auth.getUser();if(console.log("üîß Current user:",null==t?void 0:t.id),console.log("üîß User error:",o),t){const{data:s,error:r}=await e.from("profiles").select("role").eq("id",t.id).single();console.log("üîß User profile:",s),console.log("üîß Profile error:",r)}console.log("üîß About to execute update query...");const{error:a}=await e.from("assessments").update(r).eq("id",s);if(console.log("üîß Update query executed, checking for errors..."),a)throw console.error("‚ùå Error updating assessment:",a),console.error("‚ùå Error details:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a;console.log("‚úÖ Assessment updated successfully"),console.log("üîç Verifying update by checking if assessment was updated...");const{data:n,error:i}=await e.from("assessments").select("id, title, type, status").eq("id",s).single();i?console.error("‚ùå Verification failed:",i):console.log("‚úÖ Verification successful - assessment updated:",n)}static async duplicateAssessment(e){console.log("üìã DataService.duplicateAssessment called with ID:",e);const r=await s.getAssessment(e);if(!r)throw new Error("Assessment not found");const t={title:`${r.title} (Copy)`,description:r.description,course_id:r.course_id,instructor_id:r.instructor_id,type:r.type,difficulty:r.difficulty,time_limit_minutes:r.time_limit_minutes,passing_score:r.passing_score,questions:r.questions,status:"draft"},o=await s.createAssessment(t);return console.log("‚úÖ Assessment duplicated successfully:",o),o}static async deleteAssessment(s){console.log("üóëÔ∏è DataService.deleteAssessment called with ID:",s),console.log("üóëÔ∏è Supabase URL:","https://gtzbjzsjeftkgwvvgefp.supabase.co"),console.log("üóëÔ∏è Supabase Key exists:",!0);const{data:{user:r},error:t}=await e.auth.getUser();if(console.log("üóëÔ∏è Current user:",null==r?void 0:r.id),console.log("üóëÔ∏è User error:",t),r){const{data:s,error:t}=await e.from("profiles").select("role").eq("id",r.id).single();console.log("üóëÔ∏è User profile:",s),console.log("üóëÔ∏è Profile error:",t)}console.log("üóëÔ∏è About to execute delete query...");const{error:o}=await e.from("assessments").delete().eq("id",s);if(console.log("üóëÔ∏è Delete query executed, checking for errors..."),o)throw console.error("‚ùå Error deleting assessment:",o),console.error("‚ùå Error details:",{message:o.message,details:o.details,hint:o.hint,code:o.code}),o;console.log("‚úÖ Assessment deleted successfully from database"),console.log("üîç Verifying deletion by checking if assessment still exists...");const{data:a,error:n}=await e.from("assessments").select("id").eq("id",s).single();n&&"PGRST116"===n.code?console.log("‚úÖ Verification successful - assessment no longer exists"):a?console.error("‚ùå Verification failed - assessment still exists:",a):console.log("üîç Verification result:",n)}static async getAssessmentResults(s,r){let t=e.from("assessment_results").select("\n      *,\n      student:profiles!student_id(*),\n      assessment:assessments(*)\n    ");s&&(t=t.eq("student_id",s)),r&&(t=t.eq("assessment_id",r));const{data:o,error:a}=await t;if(a)throw a;return o||[]}static async submitAssessmentResult(s){const{error:r}=await e.from("assessment_results").insert(s);if(r)throw r}static async getSessions(s,r){try{let t=e.from("sessions").select("\n        *,\n        mentor:profiles!mentor_id(*),\n        student:profiles!student_id(*)\n      ");s&&"mentor"===r?t=t.eq("mentor_id",s):s&&"student"===r&&(t=t.eq("student_id",s));const{data:o,error:a}=await t;return a?(console.warn("Error fetching sessions:",a),[]):o||[]}catch(t){return console.warn("Sessions table may not exist or have permission issues:",t),[]}}static async createSession(s){const{data:r,error:t}=await e.from("sessions").insert(s).select().single();if(t)throw t;return r}static async updateSession(s,r){const{error:t}=await e.from("sessions").update(r).eq("id",s);if(t)throw t}static async getDiscussions(s){let r=e.from("discussions").select("\n      *,\n      author:profiles!author_id(*),\n      course:courses(*)\n    ");s&&(r=r.eq("course_id",s));const{data:t,error:o}=await r;if(o)throw o;return t||[]}static async createDiscussion(s){const{data:r,error:t}=await e.from("discussions").insert(s).select().single();if(t)throw t;return r}static async getNotifications(s){const{data:r,error:t}=await e.from("notifications").select("*").eq("user_id",s).order("created_at",{ascending:!1});if(t)throw t;return r||[]}static async createNotification(s){const{error:r}=await e.from("notifications").insert(s);if(r)throw r}static async markNotificationAsRead(s){const{error:r}=await e.from("notifications").update({read:!0}).eq("id",s);if(r)throw r}static async getAnalytics(){const[s,r,t,o]=await Promise.all([e.from("profiles").select("role"),e.from("courses").select("*"),e.from("enrollments").select("*"),e.from("sessions").select("*")]),a=s.data||[],n=r.data||[],i=t.data||[],l=o.data||[];return{totalUsers:a.length,activeUsers:a.filter(e=>"student"===e.role).length,totalCourses:n.length,totalEnrollments:i.length,totalSessions:l.length,completedSessions:l.filter(e=>"completed"===e.status).length}}static async searchContent(s){const[r,t,o]=await Promise.all([e.from("courses").select("*").ilike("title",`%${s}%`),e.from("profiles").select("*").ilike("name",`%${s}%`),e.from("discussions").select("*").ilike("title",`%${s}%`)]),a=[];return r.data&&a.push(...r.data.map(e=>({id:e.id,title:e.title,type:"course",description:e.description,url:`/courses/${e.id}`,metadata:{instructor:e.instructor_id}}))),t.data&&a.push(...t.data.map(e=>({id:e.id,title:e.name,type:"mentor",description:`${e.role} with experience`,url:`/mentors/${e.id}`}))),o.data&&a.push(...o.data.map(e=>({id:e.id,title:e.title,type:"discussion",description:e.content.substring(0,100)+"...",url:`/discussions/${e.id}`}))),a}static async getCourseMaterials(s){try{console.log("üîç Fetching course materials for course:",s);const{data:r,error:t}=await e.from("course_materials").select("\n          *,\n          course:courses(*),\n          uploadedBy:profiles(*)\n        ").eq("course_id",s).eq("is_public",!0).order("created_at",{ascending:!1});if(t){if(console.error("‚ùå Error fetching course materials:",t),console.error("‚ùå Error details:",{message:t.message,code:t.code,details:t.details,hint:t.hint}),"PGRST116"===t.code||t.message.includes("relation")||t.message.includes("permission"))return console.warn("‚ö†Ô∏è Course materials table may not exist or have permission issues"),[];if(t.message.includes("policy")||t.message.includes("RLS")){console.warn("‚ö†Ô∏è RLS policy blocking access, trying alternative approach...");const{data:r,error:t}=await e.from("course_materials").select("*").eq("course_id",s).eq("is_public",!0).order("created_at",{ascending:!1});return t?(console.error("‚ùå Alternative query also failed:",t),[]):(console.log("‚úÖ Course materials fetched with alternative query:",(null==r?void 0:r.length)||0,"materials"),r||[])}throw t}return console.log("‚úÖ Course materials fetched successfully:",(null==r?void 0:r.length)||0,"materials"),r||[]}catch(r){return console.error("‚ùå Error fetching course materials:",r),[]}}static async getMaterialsForStudent(s,r){try{console.log("üîç Checking enrollment for student:",r,"course:",s);const{data:t,error:o}=await e.from("enrollments").select("id").eq("student_id",r).eq("course_id",s).single();return o&&(console.warn("Enrollment check failed:",o),console.warn("This might be due to missing enrollments table or RLS policies"),console.log("‚ö†Ô∏è Skipping enrollment check, attempting to load materials directly")),t||o?(console.log("üìö Loading course materials for course:",s),await this.getCourseMaterials(s)):(console.warn("Student not enrolled in course"),[])}catch(t){return console.error("‚ùå Error fetching materials for student:",t),console.error("‚ùå Error details:",{message:t.message,code:t.code,details:t.details,hint:t.hint}),[]}}static async uploadCourseMaterial(s,r,t){var o;try{const{data:{user:a}}=await e.auth.getUser();if(!a)return{data:null,error:{message:"User not authenticated"}};const n=(null==(o=r.name.split(".").pop())?void 0:o.toLowerCase())||"",i=`course-materials/${s}/${`${Date.now()}-${r.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`}`,{data:l,error:c}=await e.storage.from("course-materials").upload(i,r,{cacheControl:"3600",upsert:!1});if(c)return console.error("File upload error:",c),{data:null,error:c};const{data:u,error:d}=await e.from("course_materials").insert({course_id:s,lesson_id:t.lessonId,title:t.title,description:t.description,file_name:r.name,file_path:i,file_size:r.size,file_type:r.type,file_extension:n,category:t.category||"general",uploaded_by:a.id}).select("\n          *,\n          course:courses(*),\n          uploadedBy:profiles(*)\n        ").single();return d?(await e.storage.from("course-materials").remove([i]),{data:null,error:d}):{data:u,error:null}}catch(a){return console.error("Error uploading course material:",a),{data:null,error:a}}}static async deleteCourseMaterial(s){try{const{data:r,error:t}=await e.from("course_materials").select("file_path").eq("id",s).single();if(t)return{error:t};const{error:o}=await e.from("course_materials").delete().eq("id",s);return o?{error:o}:((null==r?void 0:r.file_path)&&await e.storage.from("course-materials").remove([r.file_path]),{error:null})}catch(r){return console.error("Error deleting course material:",r),{error:r}}}static async getMaterialDownloadUrl(s){try{const{data:t,error:o}=await e.from("course_materials").select("file_path, file_name, title").eq("id",s).single();if(o||!t)return console.error("‚ùå Material not found:",{materialId:s,error:o}),{url:null,error:o||new Error("Material not found")};if(!t.file_path)return console.error("‚ùå Material has no file path:",t),{url:null,error:new Error("Material file path is missing")};console.log("üîç Attempting to create signed URL for:",{materialId:s,filePath:t.file_path,fileName:t.file_name,title:t.title});const{data:a,error:n}=await e.storage.from("course-materials").createSignedUrl(t.file_path,3600);if(n)return console.error("‚ùå Failed to create signed URL:",{filePath:t.file_path,error:n}),{url:null,error:n};console.log("‚úÖ Signed URL created successfully for:",t.file_name);try{await e.rpc("increment_material_download_count",{material_id:s})}catch(r){console.warn("‚ö†Ô∏è Failed to increment download count:",r)}return{url:a.signedUrl,error:null}}catch(t){return console.error("‚ùå Error getting material download URL:",t),{url:null,error:t}}}static async updateCourseMaterial(s,r){try{const{data:t,error:o}=await e.from("course_materials").update(r).eq("id",s).select("\n          *,\n          course:courses(*),\n          uploadedBy:profiles(*)\n        ").single();return{data:t,error:o}}catch(t){return console.error("Error updating course material:",t),{data:null,error:t}}}}export{s as D};
